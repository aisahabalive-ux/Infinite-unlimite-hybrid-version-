name: Permanent Monitoring — 2nm GAA Engine

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Ensure scripts are executable
        run: |
          mkdir -p scripts
          chmod +x scripts/*.js || true

      - name: Install project deps if present (skip if none)
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          elif [ -f package.json ]; then
            npm install
          else
            echo "No package.json — skipping npm install"
          fi

      - name: Run monitor script
        id: run-monitor
        run: |
          node scripts/monitor.js
          echo "monitor_exit_code=$?" >> $GITHUB_OUTPUT

      - name: Create Pull Request with changes (if any)
        if: success() && steps.run-monitor.outcome == 'success'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "[monitor] Auto-evolve 2nm GAA engine — scheduled run"
          branch: monitor/auto-evolve-$(date +%Y%m%d%H%M%S)
          title: "[monitor] Suggested optimizations for 2nm GAA engine"
          body: |
            This PR was created automatically by the Permanent Monitoring workflow.
            It contains suggested/evolved changes to the 2nm GAA engine based on scheduled performance checks.
            Please review and merge if acceptable.
          labels: automated, monitoring
